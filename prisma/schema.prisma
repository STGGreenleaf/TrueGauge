// TrueGauge - Prisma Schema
// Multi-tenant PostgreSQL on Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Multi-tenancy: Organizations and Users
model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       OrganizationUser[]
  settings    Settings?
  dayEntries  DayEntry[]
  expenses    ExpenseTransaction[]
  vendors     VendorTemplate[]
  references  ReferenceMonth[]
  injections  CashInjection[]
}

model User {
  id        String   @id // Supabase auth user ID
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizations OrganizationUser[]
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           String       @default("member") // "owner", "admin", "member"
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

// SalesInputMode: NET_SALES_EX_TAX, TOTAL_INCLUDES_TAX, DEPOSIT_NET_OF_FEES
// ExpenseCategory: COGS, OPEX, TAX, CAPEX, OWNER_DRAW, OTHER
// RecurrenceRule: NONE, WEEKLY, MONTHLY

model Settings {
  id                   String   @id @default(cuid())
  organizationId       String   @unique
  businessName         String   @default("My Business")
  timezone             String   @default("America/Denver")
  salesInputMode       String   @default("NET_SALES_EX_TAX")
  targetCogsPct        Float    @default(0.35)
  targetFeesPct        Float    @default(0.03)
  monthlyFixedNut      Float    @default(15500)
  // Individual NUT breakdown (sum = monthlyFixedNut)
  nutRent              Float    @default(0)
  nutUtilities         Float    @default(0)
  nutPhone             Float    @default(0)
  nutInternet          Float    @default(0)
  nutInsurance         Float    @default(0)
  nutLoanPayment       Float    @default(0)
  nutPayroll           Float    @default(0)
  nutOther1            Float    @default(0)
  nutOther1Label       String   @default("Other 1")
  nutOther2            Float    @default(0)
  nutOther2Label       String   @default("Other 2")
  nutOther3            Float    @default(0)
  nutOther3Label       String   @default("Other 3")
  // Optional goals
  monthlyRoofFund      Float    @default(0)
  monthlyOwnerDrawGoal Float    @default(0)
  openHoursTemplate    String   @default("{\"mon\":0,\"tue\":8,\"wed\":8,\"thu\":8,\"fri\":8,\"sat\":8,\"sun\":5}")
  storeCloseHour       Int      @default(16) // 24-hour format, default 4 PM
  enableTrueHealth     Boolean  @default(true)
  enableSpreading      Boolean  @default(true)
  // Cash snapshot for liquidity tracking
  cashSnapshotAmount   Float?   // nullable - dollars on hand at snapshot date
  cashSnapshotAsOf     String?  // nullable - ISO YYYY-MM-DD
  // Reserve thresholds for Liquidity Receiver
  operatingFloorCash   Float    @default(0)      // minimum operating balance
  targetReserveCash    Float    @default(100000) // target reserve goal
  // Year Start anchor for Continuity Mode estimation
  yearStartCashAmount  Float?   // nullable - cash on hand at year start (for estimates)
  yearStartCashDate    String   @default("2025-01-01") // ISO YYYY-MM-DD
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model DayEntry {
  id             String    @id @default(cuid())
  organizationId String
  date           String    // ISO date YYYY-MM-DD
  netSalesExTax  Float?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
}

model ExpenseTransaction {
  id             String   @id @default(cuid())
  organizationId String
  date           String   // ISO date YYYY-MM-DD
  vendorId       String?
  vendorName     String
  category       String   // COGS, OPEX, TAX, CAPEX, OWNER_DRAW, OTHER
  amount         Float
  memo           String?
  spreadMonths   Int?     // null or 1 = no spread, >= 2 = amortize
  createdAt      DateTime @default(now())

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor         VendorTemplate? @relation(fields: [vendorId], references: [id])
}

model VendorTemplate {
  id                    String   @id @default(cuid())
  organizationId        String
  name                  String
  defaultCategory       String   // COGS, OPEX, TAX, CAPEX, OWNER_DRAW, OTHER
  typicalAmount         Float?
  isRecurring           Boolean  @default(false)
  recurrenceRule        String   @default("NONE") // NONE, WEEKLY, MONTHLY
  dueDayOfMonth         Int?
  autopopulateChecklist Boolean  @default(true)
  createdAt             DateTime @default(now())

  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses              ExpenseTransaction[]

  @@unique([organizationId, name])
}

model ReferenceMonth {
  id                     String   @id @default(cuid())
  organizationId         String
  year                   Int
  month                  Int      // 1-12
  referenceNetSalesExTax Float
  note                   String?
  createdAt              DateTime @default(now())

  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, year, month])
}

model CashInjection {
  id             String   @id @default(cuid())
  organizationId String
  date           String   // ISO date YYYY-MM-DD
  amount         Float    // Amount (positive value)
  type           String   @default("injection") // "injection" = capital in, "withdrawal" = capital out (draws, paybacks)
  note           String?  // Optional description
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}
