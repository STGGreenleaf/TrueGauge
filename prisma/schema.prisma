generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id              String               @id @default(cuid())
  name            String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  cashSnapshots   CashSnapshot[]
  injections      CashInjection[]
  dayEntries      DayEntry[]
  expenses        ExpenseTransaction[]
  invites         Invite[]
  users           OrganizationUser[]
  references      ReferenceMonth[]
  settings        Settings?
  vendors         VendorTemplate[]
  yearStartAnchors YearStartAnchor[]
  nutSnapshots    NutSnapshot[]
  feedback        Feedback[]
  activities      UserActivity[]
  sessions        UserSession[]
}

model CashSnapshot {
  id             String       @id @default(cuid())
  organizationId String
  amount         Float
  date           String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([date])
}

model YearStartAnchor {
  id             String       @id @default(cuid())
  organizationId String
  year           Int
  amount         Float
  date           String
  note           String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, year])
  @@index([organizationId])
}

model NutSnapshot {
  id             String       @id @default(cuid())
  organizationId String
  amount         Float
  effectiveDate  String       // YYYY-MM-DD when this NUT became effective
  note           String?      // "Roof repair", "New hire", "Rent increase", etc.
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([effectiveDate])
}

model User {
  id            String             @id
  email         String             @unique
  name          String?
  avatarUrl     String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  organizations OrganizationUser[]
  feedback      Feedback[]
  activities    UserActivity[]
  sessions      UserSession[]
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           String       @default("member")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Invite {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           String       @default("member")
  invitedBy      String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([email])
  @@index([organizationId])
}

model Settings {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  businessName         String       @default("My Business")
  timezone             String       @default("America/Denver")
  salesInputMode       String       @default("NET_SALES_EX_TAX")
  targetCogsPct        Float        @default(0.35)
  targetFeesPct        Float        @default(0.03)
  monthlyFixedNut      Float        @default(15500)
  nutRent              Float        @default(0)
  nutUtilities         Float        @default(0)
  nutPhone             Float        @default(0)
  nutInternet          Float        @default(0)
  nutInsurance         Float        @default(0)
  nutLoanPayment       Float        @default(0)
  nutPayroll           Float        @default(0)
  nutSubscriptions     Float        @default(0)
  nutOther1            Float        @default(0)
  nutOther1Label       String       @default("Other 1")
  nutOther1Note        String?
  nutOther2            Float        @default(0)
  nutOther2Label       String       @default("Other 2")
  nutOther2Note        String?
  nutOther3            Float        @default(0)
  nutOther3Label       String       @default("Other 3")
  nutOther3Note        String?
  monthlyRoofFund      Float        @default(0)
  monthlyRoofFundLabel String       @default("Monthly Roof Fund")
  monthlyOwnerDrawGoal Float        @default(0)
  openHoursTemplate    String       @default("{\"mon\":0,\"tue\":8,\"wed\":8,\"thu\":8,\"fri\":8,\"sat\":8,\"sun\":5}")
  storeCloseHour       Int          @default(16)
  enableTrueHealth     Boolean      @default(true)
  enableSpreading      Boolean      @default(true)
  cashSnapshotAmount   Float?
  cashSnapshotAsOf     String?
  operatingFloorCash   Float        @default(0)
  targetReserveCash    Float        @default(100000)
  yearStartCashAmount  Float?
  yearStartCashDate    String       @default("2025-01-01")
  businessStartDate    String?
  splashDuration       Int          @default(3000)
  ogTitle              String       @default("TrueGauge - Precision Business Health")
  ogDescription        String       @default("Your instrument panel for business clarity")
  seoTitle             String       @default("TrueGauge")
  seoDescription       String       @default("Business health dashboard for smart operators")
  seoKeywords          String       @default("business dashboard, financial health, analytics")
  robotsIndex          Boolean      @default(true)
  robotsFollow         Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model DayEntry {
  id             String       @id @default(cuid())
  organizationId String
  date           String
  netSalesExTax  Float?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, date])
  @@index([organizationId])
}

model ExpenseTransaction {
  id             String          @id @default(cuid())
  organizationId String
  date           String
  vendorId       String?
  vendorName     String
  category       String
  amount         Float
  memo           String?
  spreadMonths   Int?
  createdAt      DateTime        @default(now())
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  vendor         VendorTemplate? @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
}

model VendorTemplate {
  id                    String               @id @default(cuid())
  organizationId        String
  name                  String
  defaultCategory       String
  typicalAmount         Float?
  isRecurring           Boolean              @default(false)
  recurrenceRule        String               @default("NONE")
  dueDayOfMonth         Int?
  autopopulateChecklist Boolean              @default(true)
  createdAt             DateTime             @default(now())
  expenses              ExpenseTransaction[]
  organization          Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ReferenceMonth {
  id                     String       @id @default(cuid())
  organizationId         String
  year                   Int
  month                  Int
  referenceNetSalesExTax Float
  note                   String?
  createdAt              DateTime     @default(now())
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, year, month])
  @@index([organizationId])
}

model CashInjection {
  id             String       @id @default(cuid())
  organizationId String
  date           String
  amount         Float
  type           String       @default("injection")
  note           String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([organizationId])
}

model Feedback {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  type           String       @default("feature")
  message        String
  status         String       @default("unread")
  ownerReply     String?
  repliedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model UserActivity {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  action         String
  page           String?
  metadata       String?
  createdAt      DateTime     @default(now())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

model UserSession {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  startedAt      DateTime     @default(now())
  endedAt        DateTime?
  durationMs     Int?
  pagesViewed    Int          @default(1)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([startedAt])
}
