generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id         String               @id @default(cuid())
  name       String
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  injections CashInjection[]
  dayEntries DayEntry[]
  expenses   ExpenseTransaction[]
  users      OrganizationUser[]
  references ReferenceMonth[]
  settings   Settings?
  vendors    VendorTemplate[]
}

model User {
  id            String             @id
  email         String             @unique
  name          String?
  avatarUrl     String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  organizations OrganizationUser[]
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           String       @default("member")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Settings {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  businessName         String       @default("My Business")
  timezone             String       @default("America/Denver")
  salesInputMode       String       @default("NET_SALES_EX_TAX")
  targetCogsPct        Float        @default(0.35)
  targetFeesPct        Float        @default(0.03)
  monthlyFixedNut      Float        @default(15500)
  nutRent              Float        @default(0)
  nutUtilities         Float        @default(0)
  nutPhone             Float        @default(0)
  nutInternet          Float        @default(0)
  nutInsurance         Float        @default(0)
  nutLoanPayment       Float        @default(0)
  nutPayroll           Float        @default(0)
  nutSubscriptions     Float        @default(0)
  nutOther1            Float        @default(0)
  nutOther1Label       String       @default("Other 1")
  nutOther1Note        String?
  nutOther2            Float        @default(0)
  nutOther2Label       String       @default("Other 2")
  nutOther2Note        String?
  nutOther3            Float        @default(0)
  nutOther3Label       String       @default("Other 3")
  nutOther3Note        String?
  monthlyRoofFund      Float        @default(0)
  monthlyOwnerDrawGoal Float        @default(0)
  openHoursTemplate    String       @default("{\"mon\":0,\"tue\":8,\"wed\":8,\"thu\":8,\"fri\":8,\"sat\":8,\"sun\":5}")
  storeCloseHour       Int          @default(16)
  enableTrueHealth     Boolean      @default(true)
  enableSpreading      Boolean      @default(true)
  cashSnapshotAmount   Float?
  cashSnapshotAsOf     String?
  operatingFloorCash   Float        @default(0)
  targetReserveCash    Float        @default(100000)
  yearStartCashAmount  Float?
  yearStartCashDate    String       @default("2025-01-01")
  businessStartDate    String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model DayEntry {
  id             String       @id @default(cuid())
  organizationId String
  date           String
  netSalesExTax  Float?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, date])
  @@index([organizationId])
}

model ExpenseTransaction {
  id             String          @id @default(cuid())
  organizationId String
  date           String
  vendorId       String?
  vendorName     String
  category       String
  amount         Float
  memo           String?
  spreadMonths   Int?
  createdAt      DateTime        @default(now())
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  vendor         VendorTemplate? @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
}

model VendorTemplate {
  id                    String               @id @default(cuid())
  organizationId        String
  name                  String
  defaultCategory       String
  typicalAmount         Float?
  isRecurring           Boolean              @default(false)
  recurrenceRule        String               @default("NONE")
  dueDayOfMonth         Int?
  autopopulateChecklist Boolean              @default(true)
  createdAt             DateTime             @default(now())
  expenses              ExpenseTransaction[]
  organization          Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ReferenceMonth {
  id                     String       @id @default(cuid())
  organizationId         String
  year                   Int
  month                  Int
  referenceNetSalesExTax Float
  note                   String?
  createdAt              DateTime     @default(now())
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organizationId, year, month])
  @@index([organizationId])
}

model CashInjection {
  id             String       @id @default(cuid())
  organizationId String
  date           String
  amount         Float
  type           String       @default("injection")
  note           String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([organizationId])
}
